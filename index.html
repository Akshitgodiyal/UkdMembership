<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>UKD Membership Card</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="bg-light">
    <div class="container my-4">
      <div
        class="ukdText text-center"
        style="font-size: 30px; margin: 20px auto"
      >
        UKD Membership Card Generator
      </div>

      <div class="row mb-4 flex-column flex-md-row">
        <!-- Form -->
        
        <div class="col-md-4 px-2 px-md-5 mb-4 mb-md-0">
               <div class=" text-center my-2" style="font-size: 16px; font-weight: 700;">Member details</div>
          <form id="cardForm">
            <div class="mb-2">
              <label class="form-label">Name</label
              ><input
                type="text"
                class="form-control"
                id="name"
                value="Member Name"
              />
            </div>
            <div class="mb-2">
              <label class="form-label">ID Number</label
              ><input
                type="text"
                class="form-control"
                id="idNo"
                value="UKD001"
              />
            </div>
            <div class="mb-2">
              <label class="form-label">State</label
              ><input
              disabled
                type="text"
                class="form-control"
                id="state"
                value="‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§ñ‡§Ç‡§°"
              />
            </div>
            <div class="mb-2">
              <label class="form-label">District</label>
              <!-- <input
                type="text"
                class="form-control"
                id="district"
                value="‡§™‡•å‡§°‡§º‡•Ä ‡§ó‡§¢‡§º‡§µ‡§æ‡§≤"
              /> -->
              <select class="form-select" id="district">
                <option value="---">Select District</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Constituency</label>
              <select class="form-select" id="vidhanSabha">
                <option value="---">Select Vidhan Sabha</option>
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label">Position</label
              ><input
                type="text"
                class="form-control"
                id="position"
                value="‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞‡•Ä‡§Ø ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Upload Profile Image</label
              ><input
                type="file"
                class="form-control"
                id="imageUpload"
                accept="image/*"
              />
            </div>

            <!-- Validity Input with Datepicker -->
            <div class="mb-3">
              <label for="validity" class="form-label">Validity</label>
              <input
                type="text"
                id="validity"
                class="form-control datepicker"
                placeholder="Select date"
              
              />
            </div>

            <button
              type="button"
              class="btn download-btn"
              onclick="exportCard()"
              id="downloadBtn"
            >
              üì• Export Card as Image
            </button>
            <div id="statusMessage" class="status-message"></div>
          </form>
        </div>

        <!-- Card -->
          
        <div class="col-md-8  ">
             <div class=" text-center my-2" style="font-size: 16px; font-weight: 700;">Card View</div>
          <div
            id="fullExport"
            class="w-100 d-flex justify-content-center overflow-sm-auto"
          >
            <div
              class="border-wrapper"
              id="cardContainer"
              style="transform: scale(0.8); transform-origin: top"
            >
              <!-- Do not modify this section - card-template content remains exactly the same -->
              <div class="top-border"></div>
              <div class="bottom-border"></div>
              <div class="border-left"></div>
              <div class="border-right"></div>
              <div class="card-template" id="membershipCard">
                <div class="ukdflag"></div>
                <div class="d-flex justify-content-between align-items-center">
                  <img src="./ukd.jfif" class="logo" />
                  <div><div class="ukdText">‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§ñ‡§Ç‡§° ‡§ï‡•ç‡§∞‡§æ‡§Ç‡§§‡§ø ‡§¶‡§≤</div></div>
                  <img src="./logo2.jpg" class="logo" />
                </div>

                <div class="section-title">‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§ï‡§æ‡§∞‡•ç‡§°</div>
                <div class="d-flex justify-content-between px-3">
                  <div class="d-flex mt-1">
                    <div class="d-flex flex-column align-items-center">
                      <div class="mb-1 values" id="cardName">
                        
                      </div>
                      <div
                        id="profilePic"
                        class="profile-pic me-3 d-flex align-items-center justify-content-center"
                        style="background: #f0f0f0; color: #666"
                      >
                        Photo
                      </div>
                    </div>
                    <div
                      class="d-flex flex-column justify-content-between mt-4"
                    >
                      <div class="my-1">
                        <span class="label">‡§Ü‡§à. ‡§°‡•Ä. ‡§®‡§Ç :</span>
                        <span class="values" id="cardId">----</span>
                      </div>
                      <div class="mb-1">
                        <span class="label">‡§∞‡§æ‡§ú‡•ç‡§Ø :</span>
                        <span class="values" id="cardState">----</span>
                      </div>
                      <div class="mb-1">
                        <span class="label">‡§ú‡§ø‡§≤‡§æ :</span>
                        <span class="values" id="cardDistrict"
                          >---</span
                        >
                      </div>
                      <div class="mb-1">
                        <span class="label">‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ :</span>
                        <span class="values" id="cardConstituency"
                          >----</span
                        >
                      </div>
                      <div class="mb-1">
                        <span class="label">‡§µ‡•à‡§ß :</span>
                        <span class="values" id="cardValid">----</span>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex flex-column align-items-end">
                    <img src="./qrcode.PNG" alt="" class="qrimg" />
                    <a class="bold" href="https://ourukd.in">www.ourUKD.in</a>
                  </div>
                </div>
                <div
                  class="text-end postname px-3 fw-bold mt-2"
                  id="cardNameFooter"
                >
                  
                </div>
                <div class="postname text-end px-3 fw-bold" id="cardPosition">
                  ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞‡•Ä‡§Ø ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑
                </div>
                <div class="d-flex footer flex-column fw-bold">
                  <div class="footertextgreen center">‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§ñ‡§Ç‡§° ‡§ï‡•ç‡§∞‡§æ‡§Ç‡§§‡§ø ‡§¶‡§≤</div>
                  <div class="footer-add center">
                    ‡§ï‡•ç‡§∞‡§æ‡§Ç‡§§‡§ø ‡§≠‡§µ‡§®, 10 ‡§ï‡•ã‡§∞‡•ç‡§ü ‡§∞‡•ã‡§°, ‡§¶‡•á‡§π‡§∞‡§æ‡§¶‡•Ç‡§®
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Static mapping of Uttarakhand districts and Vidhan Sabha constituencies
      const uttarakhandData = {
        ‡§Ö‡§≤‡•ç‡§Æ‡•ã‡§°‡§º‡§æ: ["‡§Ö‡§≤‡•ç‡§Æ‡•ã‡§°‡§º‡§æ", "‡§∏‡•ã‡§Æ‡•á‡§∂‡•ç‡§µ‡§∞ (‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ú‡§æ‡§§‡§ø)", "‡§∏‡§æ‡§≤‡•ç‡§ü", "‡§ú‡§æ‡§ó‡•á‡§∂‡•ç‡§µ‡§∞"],
        ‡§¨‡§æ‡§ó‡•á‡§∂‡•ç‡§µ‡§∞: ["‡§¨‡§æ‡§ó‡•á‡§∂‡•ç‡§µ‡§∞ (‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ú‡§æ‡§§‡§ø)", "‡§ï‡§™‡§ï‡•ã‡§ü"],
        ‡§ö‡§Æ‡•ã‡§≤‡•Ä: ["‡§¨‡§¶‡•ç‡§∞‡•Ä‡§®‡§æ‡§•", "‡§ú‡•ã‡§∂‡•Ä‡§Æ‡§†", "‡§•‡§∞‡§æ‡§≤‡•Ä (‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ú‡§æ‡§§‡§ø)"],
        ‡§ö‡§Ç‡§™‡§æ‡§µ‡§§: ["‡§ö‡§Ç‡§™‡§æ‡§µ‡§§", "‡§≤‡•ã‡§π‡§æ‡§ò‡§æ‡§ü"],
        ‡§¶‡•á‡§π‡§∞‡§æ‡§¶‡•Ç‡§®: [
          "‡§Æ‡§∏‡•Ç‡§∞‡•Ä",
          "‡§∞‡§æ‡§ú‡§™‡•Å‡§∞ ‡§∞‡•ã‡§°",
          "‡§¶‡•á‡§π‡§∞‡§æ‡§¶‡•Ç‡§® ‡§ï‡•à‡§Ç‡§ü‡•ã‡§®‡§Æ‡•á‡§Ç‡§ü",
          "‡§µ‡§ø‡§ï‡§æ‡§∏‡§®‡§ó‡§∞",
          "‡§∏‡§π‡§∏‡§™‡•Å‡§∞",
          "‡§°‡•ã‡§à‡§µ‡§æ‡§≤‡§æ",
          "‡§ã‡§∑‡§ø‡§ï‡•á‡§∂",
        ],
        ‡§π‡§∞‡§ø‡§¶‡•ç‡§µ‡§æ‡§∞: [
          "‡§π‡§∞‡§ø‡§¶‡•ç‡§µ‡§æ‡§∞",
          "‡§ú‡•ç‡§µ‡§æ‡§≤‡§æ‡§™‡•Å‡§∞ (‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ú‡§æ‡§§‡§ø)",
          "‡§≠‡•á‡§≤ ‡§∞‡§æ‡§®‡•Ä‡§™‡•Å‡§∞",
          "‡§π‡§∞‡§ø‡§¶‡•ç‡§µ‡§æ‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£",
          "‡§≤‡§ï‡•ç‡§∏‡§∞",
          "‡§ñ‡§æ‡§®‡§™‡•Å‡§∞",
          "‡§Æ‡§Ç‡§ó‡§≤‡•å‡§∞",
          "‡§™‡•Ä‡§∞‡§® ‡§ï‡§≤‡§ø‡§Ø‡§∞",
        ],
        ‡§®‡•à‡§®‡•Ä‡§§‡§æ‡§≤: [
          "‡§≤‡§æ‡§≤‡§ï‡•Å‡§Ü‡§Ç",
          "‡§≠‡•Ä‡§Æ‡§§‡§æ‡§≤",
          "‡§®‡•à‡§®‡•Ä‡§§‡§æ‡§≤",
          "‡§π‡§≤‡•ç‡§¶‡•ç‡§µ‡§æ‡§®‡•Ä",
          "‡§ï‡§æ‡§≤‡§æ‡§¢‡•Ç‡§Ç‡§ó‡•Ä",
          "‡§∞‡§æ‡§Æ‡§®‡§ó‡§∞",
        ],
        "‡§™‡•å‡§°‡§º‡•Ä ‡§ó‡§¢‡§º‡§µ‡§æ‡§≤": [
          "‡§∂‡•ç‡§∞‡•Ä‡§®‡§ó‡§∞",
          "‡§ö‡•å‡§¨‡§ü‡•ç‡§ü‡§æ‡§ñ‡§æ‡§≤",
          "‡§ß‡•Ç‡§Æ‡§æ‡§ï‡•ã‡§ü",
          "‡§≤‡•à‡§Ç‡§∏‡§°‡§æ‡§â‡§®",
          "‡§ï‡•ã‡§ü‡§¶‡•ç‡§µ‡§æ‡§∞",
          "‡§Ø‡§Æ‡§ï‡•á‡§∂‡•ç‡§µ‡§∞",
        ],
        ‡§™‡§ø‡§•‡•å‡§∞‡§æ‡§ó‡§¢‡§º: [
          "‡§™‡§ø‡§•‡•å‡§∞‡§æ‡§ó‡§¢‡§º",
          "‡§°‡•Ä‡§°‡•Ä‡§π‡§æ‡§ü",
          "‡§ó‡§Ç‡§ó‡•ã‡§≤‡•Ä‡§π‡§æ‡§ü (‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ú‡§æ‡§§‡§ø)",
          "‡§ß‡§æ‡§∞‡§ö‡•Ç‡§≤‡§æ",
        ],
        ‡§∞‡•Å‡§¶‡•ç‡§∞‡§™‡•ç‡§∞‡§Ø‡§æ‡§ó: ["‡§∞‡•Å‡§¶‡•ç‡§∞‡§™‡•ç‡§∞‡§Ø‡§æ‡§ó", "‡§ï‡•á‡§¶‡§æ‡§∞‡§®‡§æ‡§•"],
        "‡§ü‡§ø‡§π‡§∞‡•Ä ‡§ó‡§¢‡§º‡§µ‡§æ‡§≤": [
          "‡§™‡•ç‡§∞‡§§‡§æ‡§™‡§®‡§ó‡§∞",
          "‡§ü‡§ø‡§π‡§∞‡•Ä",
          "‡§®‡§∞‡•á‡§Ç‡§¶‡•ç‡§∞‡§®‡§ó‡§∞",
          "‡§ß‡§®‡•ã‡§≤‡•ç‡§ü‡•Ä",
          "‡§ò‡§®‡§∏‡§æ‡§≤‡•Ä (‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ú‡§æ‡§§‡§ø)",
        ],
        "‡§â‡§ß‡§Æ ‡§∏‡§ø‡§Ç‡§π ‡§®‡§ó‡§∞": [
          "‡§∏‡§ø‡§§‡§æ‡§∞‡§ó‡§Ç‡§ú",
          "‡§®‡§æ‡§®‡§™‡§æ‡§∞‡§æ",
          "‡§ï‡§æ‡§∂‡•Ä‡§™‡•Å‡§∞",
          "‡§ï‡§ø‡§ö‡•ç‡§õ‡§æ",
          "‡§¨‡§æ‡§ú‡§™‡•Å‡§∞ (‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ú‡§æ‡§§‡§ø)",
          "‡§ó‡§¶‡§∞‡§™‡•Å‡§∞",
          "‡§∞‡•Å‡§¶‡•ç‡§∞‡§™‡•Å‡§∞",
          "‡§ñ‡§ü‡•Ä‡§Æ‡§æ",
          "‡§ú‡§∏‡§™‡•Å‡§∞",
        ],
        ‡§â‡§§‡•ç‡§§‡§∞‡§ï‡§æ‡§∂‡•Ä: ["‡§™‡•Å‡§∞‡•ã‡§≤‡§æ (‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ú‡§æ‡§§‡§ø)", "‡§ó‡§Ç‡§ó‡•ã‡§§‡•ç‡§∞‡•Ä", "‡§Ø‡§Æ‡•Å‡§®‡•ã‡§§‡•ç‡§∞‡•Ä"],
      };

      const districtSelect = document.getElementById("district");
      Object.keys(uttarakhandData).forEach((district) => {
        const opt = document.createElement("option");
        opt.value = district;
        opt.textContent = district;
        districtSelect.appendChild(opt);
      });

      // Populate Vidhan Sabha based on district selection
      districtSelect.addEventListener("change", function () {
        const vidhanSabhaSelect = document.getElementById("vidhanSabha");
        vidhanSabhaSelect.innerHTML =
          '<option value="">Select Vidhan Sabha</option>';

        if (this.value && uttarakhandData[this.value]) {
          uttarakhandData[this.value].forEach((vs) => {
            const opt = document.createElement("option");
            opt.value = vs;
            opt.textContent = vs;
            vidhanSabhaSelect.appendChild(opt);
          });
        }
      });
      // Show status message
      function showStatus(message, isError = false) {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.textContent = message;
        statusDiv.className = `status-message ${
          isError ? "status-error" : "status-success"
        }`;
        statusDiv.style.display = "block";

        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 5000);
      }

      // Update card in real-time
      const updateCard = () => {
        const name = document.getElementById("name").value;
        const position = document.getElementById("position").value;
        document.getElementById("cardName").innerText = name;
        document.getElementById("cardNameFooter").innerText = name;
        document.getElementById("cardId").innerText =
          document.getElementById("idNo").value;
        document.getElementById("cardState").innerText =
          document.getElementById("state").value;
        document.getElementById("cardDistrict").innerText =
          document.getElementById("district").value;
        document.getElementById("cardConstituency").innerText =
          document.getElementById("vidhanSabha").value;
        document.getElementById("cardPosition").innerText = position;
        document.getElementById("cardValid").innerText =
          document.getElementById("validity").value || "----";
      };

      // Listen for form changes
      document.getElementById("cardForm").addEventListener("input", updateCard);
      // Initialize datepicker
      $(document).ready(function () {
        $("#validity")
          .datepicker({
            format: "dd/mm/yyyy", // Change to "yyyy" if you want only year
            autoclose: true,
            todayHighlight: true,
          })
          .on("changeDate", function (e) {
            const selectedDate = e.format();
            document.getElementById("cardValid").innerText = selectedDate;
          });
      });

      // Handle image upload
      document
        .getElementById("imageUpload")
        .addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (!file) return;

          // Validate file type
          if (!file.type.startsWith("image/")) {
            showStatus("Please select a valid image file.", true);
            return;
          }

          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            showStatus("Image size should be less than 5MB.", true);
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            const profileDiv = document.getElementById("profilePic");
            profileDiv.style.backgroundImage = `url(${e.target.result})`;
            profileDiv.style.backgroundSize = "cover";
            profileDiv.style.backgroundPosition = "center";
            profileDiv.innerHTML = ""; // Remove placeholder text
            showStatus("Profile image uploaded successfully!");
          };
          reader.onerror = () => {
            showStatus("Error reading image file.", true);
          };
          reader.readAsDataURL(file);
        });

      // Convert image to base64 to avoid CORS issues
      function convertImageToBase64(img) {
        return new Promise((resolve) => {
          if (!img.src || img.src.startsWith("data:")) {
            resolve(img.src);
            return;
          }

          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.naturalWidth || img.width;
          canvas.height = img.naturalHeight || img.height;

          img.crossOrigin = "anonymous";

          const handleLoad = () => {
            try {
              ctx.drawImage(img, 0, 0);
              const base64 = canvas.toDataURL("image/png");
              resolve(base64);
            } catch (e) {
              console.warn("Could not convert image:", e);
              resolve("");
            }
          };

          if (img.complete) {
            handleLoad();
          } else {
            img.onload = handleLoad;
            img.onerror = () => resolve("");
          }
        });
      }

      // Export card as image
      async function exportCard() {
        const downloadBtn = document.getElementById("downloadBtn");
        const originalText = downloadBtn.innerHTML;

        try {
          downloadBtn.innerHTML = "‚è≥ Generating...";
          downloadBtn.disabled = true;

          const cardElement = document.getElementById("cardContainer");

          // Convert all images to base64 first
          const images = cardElement.querySelectorAll("img");
          const imagePromises = Array.from(images).map(async (img) => {
            const base64 = await convertImageToBase64(img);
            if (base64) img.src = base64;
          });

          await Promise.all(imagePromises);

          // Wait for font loading and render
          await document.fonts.ready;
          await new Promise((resolve) => setTimeout(resolve, 1000));

          const canvas = await html2canvas(cardElement, {
            allowTaint: true,
            useCORS: true,
            scale: 2,
            backgroundColor: "#ffffff",
            logging: true,
            letterRendering: true,
            foreignObjectRendering: false,
            imageTimeout: 10000,
            removeContainer: false,
            onclone: (clonedDoc) => {
              // Fix any styling issues in cloned document
              const clonedCard = clonedDoc.getElementById("cardContainer");
              if (clonedCard) {
                // Ensure all styles are properly applied
                const originalStyles = window.getComputedStyle(cardElement);
                clonedCard.style.fontFamily = originalStyles.fontFamily;
              }
            },
          });

          // Create and trigger download
          const link = document.createElement("a");
          const name =
            document.getElementById("name").value.replace(/\s+/g, "_") ||
            "Member";
          const idNo = document.getElementById("idNo").value || Date.now();

          link.download = `UKD_Membership_Card_${name}_${idNo}.png`;
          link.href = canvas.toDataURL("image/png", 1.0);

          // Force download
          link.style.display = "none";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          showStatus("‚úÖ Card downloaded successfully!");
        } catch (error) {
          console.error("Export error:", error);
          showStatus(`‚ùå Download failed: ${error.message}`, true);

          // Fallback: try simpler approach
          try {
            const canvas = await html2canvas(cardElement, {
              scale: 1,
              backgroundColor: "#ffffff",
            });

            const link = document.createElement("a");
            link.download = "UKD_Membership_Card.png";
            link.href = canvas.toDataURL("image/png");
            link.click();

            showStatus("‚úÖ Card downloaded (basic quality)");
          } catch (fallbackError) {
            showStatus(
              "‚ùå Download completely failed. Try refreshing the page.",
              true
            );
          }
        } finally {
          downloadBtn.innerHTML = originalText;
          downloadBtn.disabled = false;
        }
      }

      // Initialize card with default values
      document.addEventListener("DOMContentLoaded", () => {
        updateCard();
      });
    </script>
  </body>
</html>
