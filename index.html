<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>UKD Membership Card</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body style="background: #242129">
    <div class="container my-4">
      <div
        class="ukdText text-center"
        style="font-size: 30px; margin: 20px auto; color: white"
      >
        UKD Membership Card Generator
      </div>

      <div class="row mb-4 flex-column flex-md-row">
        <!-- Form -->

        <div class="col-md-4 px-2 px-md-5 mb-4 mb-md-0">
          <div
            class="text-white text-center my-2"
            style="font-size: 16px; font-weight: 700"
          >
            Member details
          </div>
          <form id="cardForm">
            <div class="mb-3">
              <label class="form-label">Name</label
              ><input
                placeholder="Member Name"
                type="text"
                class="form-control"
                id="name"
                value=""
              />
            </div>
            <div class="mb-3">
              <label class="form-label">ID Number</label
              ><input
                placeholder="Member ID No."
                type="text"
                class="form-control"
                id="idNo"
                value=""
              />
            </div>
            <div class="mb-3">
              <label class="form-label">State</label
              ><input
                placeholder="Enter State"
                type="text"
                class="form-control"
                id="state"
                value=""
              />
            </div>
            <div class="mb-3">
              <label class="form-label">District</label>
              <input
                placeholder="Enter District"
                type="text"
                class="form-control"
                id="district"
                value=""
              />
              <!-- <select class="form-select" id="district">
                <option value="---">Select District</option>
              </select> -->
            </div>
            <div class="mb-3">
              <label class="form-label">Constituency</label>
              <input
                placeholder="Enter Constituency"
                type="text"
                class="form-control"
                id="vidhanSabha"
                value=""
              />
              <!-- <select class="form-select" id="vidhanSabha">
                <option value="---">Select Vidhan Sabha</option>
              </select> -->
            </div>

            <div class="mb-3">
              <label class="form-label">Position</label
              ><input
                placeholder="Enter Position"
                type="text"
                class="form-control"
                id="position"
                value=""
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Upload Profile Image</label
              ><input
                type="file"
                class="form-control"
                id="imageUpload"
                accept="image/*"
              />
            </div>

            <!-- Validity Input with Datepicker -->
            <div class="mb-3">
              <label for="validity" class="form-label">Validity</label>
              <input
                type="text"
                id="validity"
                class="form-control datepicker"
                placeholder="Select Date"
              />
            </div>

            <button
              type="button"
              class="btn download-btn"
              onclick="exportCard()"
              id="downloadBtn"
            >
              üì• Export Card as Image
            </button>
            <div id="statusMessage" class="status-message"></div>
          </form>
        </div>

        <!-- Card -->

        <div class="col-md-8 bg-light">
          <div
            class="text-center mt-2 mb-4"
            style="font-size: 16px; font-weight: 700"
          >
            Card View
          </div>
          <div
            id="fullExport"
            class="w-100 d-flex justify-content-center overflow-sm-auto overflow-mobile"
          >
            <div
              class="border-wrapper"
              id="cardContainer"
              style="transform: scale(0.8); transform-origin: top"
            >
              <!-- Do not modify this section - card-template content remains exactly the same -->
              <div class="top-border"></div>
              <div class="bottom-border"></div>
              <div class="border-left"></div>
              <div class="border-right"></div>
              <div class="card-template" id="membershipCard">
                <div class="ukdflag"></div>
                <div class="d-flex justify-content-between align-items-center">
                  <img src="./ukd.jfif" class="logo" />
                  <div><div class="ukdText">‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§ñ‡§Ç‡§° ‡§ï‡•ç‡§∞‡§æ‡§Ç‡§§‡§ø ‡§¶‡§≤</div></div>
                  <img src="./logo2.jpg" class="logo" />
                </div>

                <div class="section-title">‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§ï‡§æ‡§∞‡•ç‡§°</div>
                <div class="d-flex justify-content-between px-3">
                  <div class="d-flex mt-1">
                    <div class="d-flex flex-column align-items-center">
                      <div class="mb-1 values" id="cardName"></div>
                      <div
                        id="profilePic"
                        class="profile-pic me-3 d-flex align-items-center justify-content-center"
                        style="background: #f0f0f0; color: #666"
                      >
                        Photo
                      </div>
                    </div>
                    <div
                      class="d-flex flex-column justify-content-between mt-4"
                    >
                      <div class="my-1">
                        <span class="label">‡§Ü‡§à. ‡§°‡•Ä. ‡§®‡§Ç :</span>
                        <span class="values" id="cardId"></span>
                      </div>
                      <div class="mb-1">
                        <span class="label">‡§∞‡§æ‡§ú‡•ç‡§Ø :</span>
                        <span class="values" id="cardState"></span>
                      </div>
                      <div class="mb-1">
                        <span class="label">‡§ú‡§ø‡§≤‡§æ :</span>
                        <span class="values" id="cardDistrict">---</span>
                      </div>
                      <div class="mb-1">
                        <span class="label">‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ :</span>
                        <span class="values" id="cardConstituency"></span>
                      </div>
                      <div class="mb-1">
                        <span class="label">‡§µ‡•à‡§ß :</span>
                        <span class="values" id="cardValid"></span>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex flex-column align-items-end">
                    <img src="./qrcode.PNG" alt="" class="qrimg" />
                    <a class="bold" href="https://ourukd.in">www.ourUKD.in</a>
                  </div>
                </div>
                <div
                  class="text-end postname px-3 fw-bold mt-2"
                  id="cardNameFooter"
                ></div>
                <div
                  class="postname text-end px-3 fw-bold"
                  id="cardPosition"
                ></div>
                <div class="d-flex footer flex-column fw-bold">
                  <div class="footertextgreen center">‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§ñ‡§Ç‡§° ‡§ï‡•ç‡§∞‡§æ‡§Ç‡§§‡§ø ‡§¶‡§≤</div>
                  <div class="footer-add center">
                    ‡§ï‡•ç‡§∞‡§æ‡§Ç‡§§‡§ø ‡§≠‡§µ‡§®, 10 ‡§ï‡•ã‡§∞‡•ç‡§ü ‡§∞‡•ã‡§°, ‡§¶‡•á‡§π‡§∞‡§æ‡§¶‡•Ç‡§®
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Static mapping of Uttarakhand districts and Vidhan Sabha constituencies

      // Show status message
      function showStatus(message, isError = false) {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.textContent = message;
        statusDiv.className = `status-message ${
          isError ? "status-error" : "status-success"
        }`;
        statusDiv.style.display = "block";

        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 5000);
      }

      // Update card in real-time
      const updateCard = () => {
        const name = document.getElementById("name").value;
        const position = document.getElementById("position").value;
        document.getElementById("cardName").innerText = name;
        document.getElementById("cardNameFooter").innerText = name;
        document.getElementById("cardId").innerText =
          document.getElementById("idNo").value;
        document.getElementById("cardState").innerText =
          document.getElementById("state").value;
        document.getElementById("cardDistrict").innerText =
          document.getElementById("district").value;
        document.getElementById("cardConstituency").innerText =
          document.getElementById("vidhanSabha").value;
        document.getElementById("cardPosition").innerText = position;
        document.getElementById("cardValid").innerText =
          document.getElementById("validity").value || "";
      };

      // Listen for form changes
      document.getElementById("cardForm").addEventListener("input", updateCard);
      // Initialize datepicker
      $(document).ready(function () {
        $("#validity")
          .datepicker({
            format: "dd/mm/yyyy", // Change to "yyyy" if you want only year
            autoclose: true,
            todayHighlight: true,
          })
          .on("changeDate", function (e) {
            const selectedDate = e.format();
            document.getElementById("cardValid").innerText = selectedDate;
          });
      });

      // Handle image upload
      document
        .getElementById("imageUpload")
        .addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (!file) return;

          // Validate file type
          if (!file.type.startsWith("image/")) {
            showStatus("Please select a valid image file.", true);
            return;
          }

          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            showStatus("Image size should be less than 5MB.", true);
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            const profileDiv = document.getElementById("profilePic");
            profileDiv.style.backgroundImage = `url(${e.target.result})`;
            profileDiv.style.backgroundSize = "cover";
            profileDiv.style.backgroundPosition = "center";
            profileDiv.innerHTML = ""; // Remove placeholder text
            showStatus("Profile image uploaded successfully!");
          };
          reader.onerror = () => {
            showStatus("Error reading image file.", true);
          };
          reader.readAsDataURL(file);
        });

      // Convert image to base64 to avoid CORS issues
      function convertImageToBase64(img) {
        return new Promise((resolve) => {
          if (!img.src || img.src.startsWith("data:")) {
            resolve(img.src);
            return;
          }

          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.naturalWidth || img.width;
          canvas.height = img.naturalHeight || img.height;

          img.crossOrigin = "anonymous";

          const handleLoad = () => {
            try {
              ctx.drawImage(img, 0, 0);
              const base64 = canvas.toDataURL("image/png");
              resolve(base64);
            } catch (e) {
              console.warn("Could not convert image:", e);
              resolve("");
            }
          };

          if (img.complete) {
            handleLoad();
          } else {
            img.onload = handleLoad;
            img.onerror = () => resolve("");
          }
        });
      }

      // Export card as image
      async function exportCard() {
        const downloadBtn = document.getElementById("downloadBtn");
        const originalText = downloadBtn.innerHTML;

        try {
          downloadBtn.innerHTML = "‚è≥ Generating...";
          downloadBtn.disabled = true;

          const cardElement = document.getElementById("cardContainer");

          // Convert all images to base64 first
          const images = cardElement.querySelectorAll("img");
          const imagePromises = Array.from(images).map(async (img) => {
            const base64 = await convertImageToBase64(img);
            if (base64) img.src = base64;
          });

          await Promise.all(imagePromises);

          // Wait for font loading and render
          await document.fonts.ready;
          await new Promise((resolve) => setTimeout(resolve, 1000));

          const canvas = await html2canvas(cardElement, {
            allowTaint: true,
            useCORS: true,
            scale: 2,
            backgroundColor: "#ffffff",
            logging: true,
            letterRendering: true,
            foreignObjectRendering: false,
            imageTimeout: 10000,
            removeContainer: false,
            onclone: (clonedDoc) => {
              // Fix any styling issues in cloned document
              const clonedCard = clonedDoc.getElementById("cardContainer");
              if (clonedCard) {
                // Ensure all styles are properly applied
                const originalStyles = window.getComputedStyle(cardElement);
                clonedCard.style.fontFamily = originalStyles.fontFamily;
              }
            },
          });

          // Create and trigger download
          const link = document.createElement("a");
          const name =
            document.getElementById("name").value.replace(/\s+/g, "_") ||
            "Member";
          const idNo = document.getElementById("idNo").value || Date.now();

          link.download = `UKD_Membership_Card_${name}_${idNo}.png`;
          link.href = canvas.toDataURL("image/png", 1.0);

          // Force download
          link.style.display = "none";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          showStatus("‚úÖ Card downloaded successfully!");
        } catch (error) {
          console.error("Export error:", error);
          showStatus(`‚ùå Download failed: ${error.message}`, true);

          // Fallback: try simpler approach
          try {
            const canvas = await html2canvas(cardElement, {
              scale: 1,
              backgroundColor: "#ffffff",
            });

            const link = document.createElement("a");
            link.download = "UKD_Membership_Card.png";
            link.href = canvas.toDataURL("image/png");
            link.click();

            showStatus("‚úÖ Card downloaded (basic quality)");
          } catch (fallbackError) {
            showStatus(
              "‚ùå Download completely failed. Try refreshing the page.",
              true
            );
          }
        } finally {
          downloadBtn.innerHTML = originalText;
          downloadBtn.disabled = false;
        }
      }

      // Initialize card with default values
      document.addEventListener("DOMContentLoaded", () => {
        updateCard();
      });
    </script>
  </body>
</html>
